<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="referrer" content="no-referrer" />
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex" />
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()" />
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data:; font-src 'self' https://cdnjs.cloudflare.com data:; connect-src 'self' https://api.coingecko.com https://blockchain.info; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests; block-all-mixed-content"
  />
  <title>mjamiv btc</title>

  <link rel="stylesheet" href="styles.css" />

  <!-- CSV parsing -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- Chart.js core -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- Date adapter & date-fns for time scales -->
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/date_fns.min.js"></script>

  <!-- Annotation plugin (must come after Chart.js) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- noUiSlider for date-range slider -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>

<body>
  <div class="container">
    <img src="btc_tracker.png" alt="mjamiv btc tracker" class="title-image"/>

    <!-- NEW: Split Tile (top of page) -->
    <div class="split-tile" id="to-one-tile" title="Progress to 1 BTC at current market price">
      <div class="split-half">
        <div class="icon"><i class="fa-solid fa-circle-half-stroke"></i></div>
        <div class="meta">
          <div class="label">BTC Needed for Whole-Coiner Status</div>
          <div class="value" id="btc-to-one">—</div>
        </div>
      </div>
      <div class="split-divider"></div>
      <div class="split-half">
        <div class="icon"><i class="fa-solid fa-dollar-sign"></i></div>
        <div class="meta">
          <div class="label">Price to Achieve Whole-Coiner Status</div>
          <div class="value" id="usd-to-one">—</div>
        </div>
      </div>
    </div>
    <!-- End Split Tile -->

    <div class="stats" id="summary">
      <!-- Total BTC -->
      <div class="stat-box" title="Total BTC">
        <i class="fas fa-coins icon"></i>
        <p class="label">Total BTC</p>
        <p class="value" id="total-btc"></p>
      </div>
      <!-- Total Invested -->
      <div class="stat-box" title="Total USD invested">
        <i class="fas fa-dollar-sign icon"></i>
        <p class="label">Total Invested</p>
        <p class="value" id="invested"></p>
      </div>
      <!-- Cost Basis -->
      <div class="stat-box" title="Average cost per BTC">
        <i class="fas fa-calculator icon"></i>
        <p class="label">Cost Basis</p>
        <p class="value" id="cost-basis"></p>
      </div>
      <!-- Current Value -->
      <div class="stat-box" title="Current USD value">
        <i class="fas fa-wallet icon"></i>
        <p class="label">Current Value</p>
        <p class="value" id="current-value"></p>
      </div>
      <!-- Gain/Loss -->
      <div class="stat-box" title="Unrealized gain/loss">
        <i class="fas fa-chart-line icon"></i>
        <p class="label">Gain/Loss</p>
        <p class="value" id="gain-loss"></p>
      </div>
    </div>

    <div class="btc-metrics" id="btc-metrics">
      <!-- Price -->
      <div class="stat-box" title="Latest BTC price">
        <i class="fas fa-tag icon"></i>
        <p class="label">Current Price</p>
        <p class="value" id="btc-price"></p>
      </div>
      <!-- Market Cap -->
      <div class="stat-box" title="Market capitalization">
        <i class="fas fa-globe icon"></i>
        <p class="label">Market Cap</p>
        <p class="value" id="btc-market-cap"></p>
      </div>
      <!-- Volume 24h -->
      <div class="stat-box" title="Trading volume (24h)">
        <i class="fas fa-exchange-alt icon"></i>
        <p class="label">24h Volume</p>
        <p class="value" id="btc-volume"></p>
      </div>
      <!-- Price Change 24h -->
      <div class="stat-box" title="Price change (24h)">
        <i class="fas fa-percentage icon"></i>
        <p class="label">24h Price Change</p>
        <p class="value" id="btc-price-change"></p>
      </div>
    </div>

    <div class="blockchain-metrics" id="blockchain-metrics">
      <!-- Block Height -->
      <div class="stat-box" title="Current block height">
        <i class="fas fa-cubes icon"></i>
        <p class="label">Current Block</p>
        <p class="value" id="btc-block-height"></p>
      </div>
      <!-- Difficulty -->
      <div class="stat-box" title="Mining difficulty">
        <i class="fas fa-tachometer-alt icon"></i>
        <p class="label">Difficulty</p>
        <p class="value" id="btc-difficulty"></p>
      </div>
      <!-- Hashrate -->
      <div class="stat-box" title="Network hashrate">
        <i class="fas fa-microchip icon"></i>
        <p class="label">Hashrate</p>
        <p class="value" id="btc-hash-rate"></p>
      </div>
      <!-- Block Reward -->
      <div class="stat-box" title="Current block reward">
        <i class="fas fa-gift icon"></i>
        <p class="label">Block Reward</p>
        <p class="value" id="btc-block-reward"></p>
      </div>
    </div>

    <div class="chart-container">
      <h2>Bitcoin Price and Purchases Over Time</h2>
      <div id="chart-error" class="error"></div>
      <canvas id="priceChart"></canvas>
      <div id="date-range-slider" class="date-range-slider"></div>
      <div id="date-range-labels" class="date-range-labels"></div>
    </div>

    <div class="table-container">
      <div class="transaction-entry-header">
        <h2>Add Transaction</h2>
        <p id="local-transaction-count" class="local-transaction-count">No local additions</p>
      </div>
      <p class="transaction-entry-note">
        New transactions are saved in this browser only until you export the CSV.
      </p>
      <form id="add-transaction-form" class="transaction-form" autocomplete="off">
        <label for="tx-timestamp">Timestamp</label>
        <input id="tx-timestamp" name="timestamp" type="datetime-local" step="1" required />

        <label for="tx-quantity">BTC Quantity</label>
        <input id="tx-quantity" name="quantity" type="number" step="0.00000001" min="0.00000001" required />

        <label for="tx-total">Total Paid (USD)</label>
        <input id="tx-total" name="total" type="number" step="0.01" min="0.01" required />

        <label for="tx-fees">Fees (USD)</label>
        <input id="tx-fees" name="fees" type="number" step="0.01" min="0" value="0" required />

        <label for="tx-exchange">Exchange</label>
        <input id="tx-exchange" name="exchange" type="text" maxlength="40" value="Coinbase" required />

        <div class="transaction-actions">
          <button id="add-transaction-button" type="submit">Add Transaction</button>
          <button id="export-transactions-button" type="button">Export Updated CSV</button>
          <button id="clear-local-transactions-button" type="button">Clear Local Additions</button>
        </div>
      </form>
      <p id="add-transaction-message" class="form-message" aria-live="polite"></p>
    </div>

    <div class="table-container">
      <h2>Transaction History</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>BTC Bought</th>
            <th>Total Cost</th>
            <th>Price at Tx</th>
            <th>Exchange</th>
          </tr>
        </thead>
        <tbody id="transactions-body"></tbody>
      </table>
    </div>

    <button id="refresh-button" type="button" class="refresh-button">Refresh</button>
  </div>

  <!-- App script -->
  <script defer src="script.js"></script>
</body>
</html>
